<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HeyGen Player Embed</title>
  <style>
    body { margin:0; background:#000; display:flex; align-items:center; justify-content:center; height:100vh; }
    #playerContainer { width:100%; height:100%; background:#000; }
    #controls { position:absolute; top:10px; left:10px; z-index:1000; display:flex; gap:8px; }
    button { padding:6px 12px; font-size:14px; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="startBtn">▶ Start</button>
    <button id="stopBtn">⏹ Stop</button>
    <button id="muteBtn">🔇 Mute</button>
    <button id="unmuteBtn">🔊 Unmute</button>
  </div>
  <div id="playerContainer"></div>

  <!-- Load the UMD build -->
  <script src="https://docstar0.github.io/heygenplayer/heygen-player.umd.js"></script>

  <script>
    console.log("[player-embed] Booting…");
    let player = null;

    window.addEventListener("message", async (evt) => {
      const data = evt.data || {};
      if (data.type === "SETUP") {
        console.log("[player-embed] 📩 parent said:", data);

        if (!window.HeyGenPlayer) {
          console.error("[player-embed] ❌ HeyGenPlayer missing from window");
          return;
        }

        try {
          console.log("[player-embed] 🛠 creating player with HeyGenPlayer.create…");
          player = HeyGenPlayer.create({
            token: data.token,
            avatarId: data.avatarId,
            kbId: data.kbId,
            container: document.getElementById("playerContainer")
          });
          console.log("[player-embed] 🎉 player created:", player);

          // Hook up controls
          document.getElementById("startBtn").onclick = async () => {
            try {
              console.log("[player-embed] 🚀 starting avatar stream…");
              await player.startAvatar();
              console.log("[player-embed] ✅ avatar started");
            } catch (err) {
              console.error("[player-embed] ❌ startAvatar failed:", err);
            }
          };

          document.getElementById("stopBtn").onclick = async () => {
            try {
              console.log("[player-embed] ⏹ stopping avatar stream…");
              await player.stopAvatar();
              console.log("[player-embed] ✅ avatar stopped");
            } catch (err) {
              console.error("[player-embed] ❌ stopAvatar failed:", err);
            }
          };

          document.getElementById("muteBtn").onclick = async () => {
            try {
              await player.muteMicrophone?.();
              console.log("[player-embed] 🔇 mic muted");
            } catch (err) {
              console.error("[player-embed] ❌ mute failed:", err);
            }
          };

          document.getElementById("unmuteBtn").onclick = async () => {
            try {
              await player.unmuteMicrophone?.();
              console.log("[player-embed] 🔊 mic unmuted");
            } catch (err) {
              console.error("[player-embed] ❌ unmute failed:", err);
            }
          };

          // ✅ Send ACK back so Wix stops retrying
          window.parent.postMessage({ type: "ACK_SETUP" }, "*");

        } catch (err) {
          console.error("[player-embed] ❌ exception during create:", err);
        }
      }
    });
  </script>
</body>
</html>
