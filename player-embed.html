<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HeyGen Player Embed</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #playerBox {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #9ee;
      font: 14px system-ui;
    }
  </style>
</head>
<body>
  <div id="playerBox">⏳ Waiting for token…</div>

  <!-- Load your HeyGen UMD bundle -->
  <script src="heygen-player.umd.js"></script>

  <script>
    console.log("[player-embed] booting…");

    const box = document.getElementById("playerBox");

    function bootWithToken(token, avatarId, kbId) {
      if (!window.HeyGenPlayer) {
        box.textContent = "❌ HeyGenPlayer missing";
        console.error("[player-embed] HeyGenPlayer missing on window");
        return;
      }
      console.log("[player-embed] ✅ Got token, starting player");

      box.innerHTML = ""; // clear placeholder
      const container = document.createElement("div");
      container.style.width = "100%";
      container.style.height = "100%";
      box.appendChild(container);

      try {
        const player = window.HeyGenPlayer.create({
          token,
          avatarId: avatarId || "Dexter_Doctor_Standing2_public",
          knowledgeBaseId: kbId || "14b2ed85d8804bf5bef881da5a7e819e",
          container
        });

        console.log("[player-embed] ✅ Player created", player);
      } catch (err) {
        console.error("[player-embed] player error", err);
        box.textContent = "❌ Player init failed";
      }
    }

    // Listen for token via postMessage from Wix
    window.addEventListener("message", (evt) => {
      if (evt?.data?.token) {
        bootWithToken(evt.data.token, evt.data.avatarId, evt.data.kbId);
      }
    });

    // OR via attribute if CE injects it
    const observer = new MutationObserver(() => {
      const token = document.body.getAttribute("data-sdk-token");
      if (token) {
        bootWithToken(token);
        observer.disconnect();
      }
    });
    observer.observe(document.body, { attributes: true });
  </script>
</body>
</html>
