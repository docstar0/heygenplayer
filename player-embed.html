<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>HeyGen Player (token-only)</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font:14px system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#000; color:#0f0; }
    #wrap { position:fixed; inset:0; display:flex; flex-direction:column; }
    #bar  { padding:8px; display:flex; gap:8px; align-items:center; border-bottom:1px solid #0a0; background:#001900; }
    #log  { flex:0 0 auto; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; line-height:1.25; max-height:30vh; overflow:auto; padding:8px; border-bottom:1px solid #0a0; background:#001400; white-space:pre-wrap; }
    #stage{ flex:1 1 auto; min-height:240px; display:grid; place-items:center; background:#000; }
    video { width:100%; height:100%; object-fit:cover; background:#000; }
    button { padding:6px 10px; border:1px solid #0a0; background:#002b00; color:#bfffbf; border-radius:8px; cursor:pointer; }
    button[disabled]{ opacity:0.5; cursor:not-allowed; }
  </style>
  <script src="https://docstar0.github.io/heygenplayer/heygen-player.umd.js"></script>
</head>
<body>
  <div id="wrap">
    <div id="bar">
      <strong>HeyGen Player</strong>
      <button id="btnStart" disabled>Start</button>
      <button id="btnStop"  disabled>Stop</button>
      <button id="btnMute"  disabled>Mute</button>
      <span id="tip" style="margin-left:auto;color:#8f8;">ready</span>
    </div>
    <div id="log"></div>
    <div id="stage">
      <video id="vid" playsinline autoplay muted></video>
    </div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    function log(...a){ console.log('[player-embed]', ...a); logEl.textContent += a.map(v=> (typeof v==='string'? v: JSON.stringify(v))).join(' ')+'\n'; logEl.scrollTop = logEl.scrollHeight; }

    let token=null, avatarId=null, kbId=null;
    let player=null;
    const vid = document.getElementById('vid');
    const btnStart = document.getElementById('btnStart');
    const btnStop  = document.getElementById('btnStop');
    const btnMute  = document.getElementById('btnMute');
    const tip      = document.getElementById('tip');

    // Handshake ACK back to parent (Wix HtmlComponent)
    try { window.parent.postMessage({ kind:'embed-ready' }, '*'); } catch {}

    // Receive payload from parent
    window.addEventListener('message', (ev)=>{
      const d = ev.data || {};
      // Expect { token, avatarId, kbId }
      if (!d.token || !d.avatarId) { log('âš ï¸ missing token or avatarId in parent message', d); return; }
      token    = d.token;
      avatarId = d.avatarId;
      kbId     = d.kbId || null;
      log('ðŸ“© parent said:', { token: token?.slice(0,12)+'â€¦', avatarId, kbId });

      btnStart.disabled = false;
      tip.textContent = 'got credentials â€” click Start';
    });

    // Create once
    async function ensurePlayer(){
      if (player) return player;
      if (!window.HeyGenPlayer || !window.HeyGenPlayer.create) {
        log('âŒ HeyGenPlayer bundle missing or invalid');
        throw new Error('HeyGenPlayer not available');
      }
      if (!token) throw new Error('No token set yet');
      player = window.HeyGenPlayer.create({ token });
      log('ðŸŽ‰ player created:', player);

      // (Best-effort) attach when stream becomes available
      const attach = () => {
        if (player && player.mediaStream) {
          try {
            if (vid.srcObject !== player.mediaStream) {
              vid.srcObject = player.mediaStream;
              vid.play().catch(()=>{ /* ignore */ });
              log('ðŸŽ¥ attached mediaStream to <video>');
            }
          } catch (e) { log('âš ï¸ attach failed:', e); }
        }
      };
      // poll for a few seconds
      let tries=0, h=setInterval(()=>{ attach(); if (++tries>40) clearInterval(h); }, 250);

      return player;
    }

    btnStart.addEventListener('click', async ()=>{
      btnStart.disabled = true;
      try{
        await ensurePlayer();
        tip.textContent = 'startingâ€¦';
        log('ðŸš€ starting avatar streamâ€¦');

        // IMPORTANT: do NOT pass sessionId. The SDK should create its own session from token
        await player.startAvatar({
          avatarName: avatarId,
          // Optional knobs you can add if needed:
          // quality: 'high',
          // voice: { provider: 'azure', voice_id: 'en-US-JennyNeural' },
          knowledgeBaseId: kbId || undefined,
        });

        // Re-attach (in case stream only appears after start)
        if (player.mediaStream) {
          vid.srcObject = player.mediaStream;
          await vid.play().catch(()=>{ /* must be user gesture */});
          log('âœ… avatar started');
          tip.textContent = 'live';
          btnStop.disabled = false;
          btnMute.disabled = false;
        } else {
          log('âš ï¸ no mediaStream yet');
          tip.textContent = 'connected (no video yet)';
          btnStop.disabled = false;
          btnMute.disabled = false;
        }
      }catch(e){
        log('âŒ startAvatar failed:', e);
        tip.textContent = 'start failed';
        btnStart.disabled = false;
      }
    });

    btnStop.addEventListener('click', async ()=>{
      try{
        if (player?.stopAvatar) await player.stopAvatar();
      }catch{}
      if (vid.srcObject) {
        const tracks = vid.srcObject.getTracks();
        tracks.forEach(t=>t.stop());
        vid.srcObject = null;
      }
      tip.textContent = 'stopped';
      btnStart.disabled = false;
      btnStop.disabled  = true;
    });

    btnMute.addEventListener('click', ()=>{
      vid.muted = !vid.muted;
      btnMute.textContent = vid.muted ? 'Unmute' : 'Mute';
    });
  </script>
</body>
</html>
