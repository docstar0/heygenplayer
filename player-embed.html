<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HeyGen Player Embed</title>
  <style>
    body { margin:0; background:#000; display:flex; align-items:center; justify-content:center; height:100vh; }
    #playerContainer { width:100%; height:100%; background:#000; }
    #controls { position:absolute; top:10px; left:10px; z-index:1000; display:flex; gap:8px; }
    button { padding:6px 12px; font-size:14px; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="startBtn">â–¶ Start</button>
    <button id="stopBtn">â¹ Stop</button>
    <button id="muteBtn">ğŸ”‡ Mute</button>
    <button id="unmuteBtn">ğŸ”Š Unmute</button>
  </div>
  <div id="playerContainer"></div>

  <!-- Load the UMD build -->
  <script src="https://docstar0.github.io/heygenplayer/heygen-player.umd.js"></script>

  <script>
    console.log("[player-embed] Bootingâ€¦");
    let player = null;

    window.addEventListener("message", async (evt) => {
      const data = evt.data || {};
      if (data.type === "SETUP") {
        console.log("[player-embed] ğŸ“© parent said:", data);

        if (!window.HeyGenPlayer) {
          console.error("[player-embed] âŒ HeyGenPlayer missing from window");
          return;
        }

        try {
          console.log("[player-embed] ğŸ›  creating player with HeyGenPlayer.createâ€¦");
          player = HeyGenPlayer.create({
            token: data.token,
            avatarId: data.avatarId,
            kbId: data.kbId,
            container: document.getElementById("playerContainer")
          });
          console.log("[player-embed] ğŸ‰ player created:", player);

          // Hook up controls
          document.getElementById("startBtn").onclick = async () => {
            try {
              console.log("[player-embed] ğŸš€ starting avatar streamâ€¦");
              await player.startAvatar();
              console.log("[player-embed] âœ… avatar started");
            } catch (err) {
              console.error("[player-embed] âŒ startAvatar failed:", err);
            }
          };

          document.getElementById("stopBtn").onclick = async () => {
            try {
              console.log("[player-embed] â¹ stopping avatar streamâ€¦");
              await player.stopAvatar();
              console.log("[player-embed] âœ… avatar stopped");
            } catch (err) {
              console.error("[player-embed] âŒ stopAvatar failed:", err);
            }
          };

          document.getElementById("muteBtn").onclick = async () => {
            try {
              await player.muteMicrophone?.();
              console.log("[player-embed] ğŸ”‡ mic muted");
            } catch (err) {
              console.error("[player-embed] âŒ mute failed:", err);
            }
          };

          document.getElementById("unmuteBtn").onclick = async () => {
            try {
              await player.unmuteMicrophone?.();
              console.log("[player-embed] ğŸ”Š mic unmuted");
            } catch (err) {
              console.error("[player-embed] âŒ unmute failed:", err);
            }
          };

          // âœ… Send ACK back so Wix stops retrying
          window.parent.postMessage({ type: "ACK_SETUP" }, "*");

        } catch (err) {
          console.error("[player-embed] âŒ exception during create:", err);
        }
      }
    });
  </script>
</body>
</html>
